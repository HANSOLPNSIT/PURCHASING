<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SW기술자 정규분포 시각화 · 표준편차 구간 계산</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --ink: #e5e7eb;       /* gray-200 */
      --muted: #9ca3af;     /* gray-400 */
      --brand: #60a5fa;     /* blue-400 */
      --good: rgba(16,185,129,.28);   /* ±1σ: green */
      --warn: rgba(234,179,8,.24);    /* ±2σ: yellow */
      --bad:  rgba(248,113,113,.22);  /* ±3σ: pinkish red */
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { max-width: 1180px; margin: 28px auto; padding: 0 16px; }
    header { display:block; margin-bottom: 12px; text-align:center; }
    h1 { font-size: clamp(20px, 3vw, 28px); margin: 0; font-weight: 700; white-space: nowrap; }
    .sub { color: var(--muted); font-size: 13px; display:block; margin-top:6px; }

    .card { background: var(--panel); border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }

    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 960px) { .grid { grid-template-columns: 380px 1fr; } }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select { width:100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.08); background: #0b1220; color: var(--ink); }
    input[type="number"] { appearance: textfield; }
    .btn { background: linear-gradient(90deg, #60a5fa, #34d399); border: none; color: #0b1220; font-weight: 700; padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.ghost { background: transparent; border:1px solid rgba(255,255,255,.15); color: var(--ink); }

    .legend { display:flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: var(--muted); }
    .swatch { width: 14px; height: 14px; border-radius: 3px; display:inline-block; margin-right: 6px; vertical-align: -2px; }

    .results { display:grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-top: 8px; }
    .pill { background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 10px; transition: box-shadow .15s, border-color .15s; }
    .pill b { color:#fff; }
    .pill.highlight { border-color: #ffffff99; box-shadow: 0 0 0 2px #ffffff33 inset; }
    .bandxs { margin-top:6px; font-size:12px; color: var(--muted); line-height: 1.4; }

    canvas { width:100%; height: 500px; border-radius: 14px; display:block; background:#0b1220; }
    .foot { margin-top: 10px; color: var(--muted); font-size: 12px; }

    .axisbox { margin-top: 12px; display:grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px; color: var(--muted); }
    .axisbox .box { background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 10px; }
    .axisbox code { white-space: pre-wrap; word-break: break-word; display:block; }

    .kv { font-size:12px; color: var(--muted); }
    .kv b { color:#fff; }

    .unitTag { position:absolute; right:14px; top:10px; font-size:12px; color:#e5e7ebb3; }
    .statLine { position:absolute; right:14px; top:30px; font-size:13px; color:#e5e7eb; opacity:.95 }
    .chartWrap { position:relative; }

    /* 업로드 영역: 하단에 작게 */
    .uploadWrap { margin-top: 18px; display:flex; justify-content:flex-end; gap:10px; align-items:center; color: var(--muted); font-size:12px; }
    #fileInput { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SW기술자 정규분포 시각화 · 표준편차 구간 계산</h1>
      <span class="sub">엑셀 업로드 후 대·중분류를 선택하면 평균(μ)·표준편차(σ)를 계산합니다. 표시는 <b>소수점 절삭</b>, 값은 <b>(단위: 천원)</b>.</span>
    </header>

    <div class="grid">
      <!-- Controls -->
      <div class="card">
        <div class="row">
          <div>
            <label>대분류</label>
            <select id="ddlA"></select>
          </div>
          <div>
            <label>중분류</label>
            <select id="ddlB"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>평균 (μ) <small>(절삭)</small></label>
            <input id="mean" type="number" value="" step="any" />
          </div>
          <div>
            <label>표준편차 (σ) <small>(절삭)</small></label>
            <input id="std" type="number" value="" step="any" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>확인 값</label>
            <input id="xval" type="number" placeholder="값을 입력하면 z-score·±σ 표기" step="any" />
          </div>
          <div>
            <label>범위 스케일</label>
            <input id="rangeMul" type="text" value="±3σ" readonly />
          </div>
        </div>
        <div class="row">
          <button class="btn" id="calcBtn">시뮬레이션</button>
          <button class="btn ghost" id="resetBtn" title="선택 초기화">초기화</button>
        </div>

        <div class="legend" style="margin-top:8px">
          <div><span class="swatch" style="background:var(--good)"></span>±1σ: |x-μ| ≤ 1σ (초록)</div>
          <div><span class="swatch" style="background:var(--warn)"></span>±2σ: 1σ < |x-μ| ≤ 2σ (노랑)</div>
          <div><span class="swatch" style="background:var(--bad)"></span>±3σ: 2σ < |x-μ| ≤ 3σ (핑크)</div>
          <div><span class="swatch" style="background:#ffffff"></span>정규분포선(PDF, 흰색)</div>
        </div>

        <div class="results" id="rangesBox"></div>
        <div id="xinfo" class="foot"></div>
      </div>

      <!-- Chart -->
      <div class="card chartWrap">
        <span class="unitTag">(단위: 천원)</span>
        <span class="statLine" id="statLine"></span>
        <canvas id="chart" width="1024" height="520"></canvas>
        <div class="axisbox" id="axisBox">
          <div class="box">
            <b>X축 눈금값 (밴드 중앙)</b>
            <code id="xTicks"></code>
          </div>
          <div class="box">
            <b>Y축 눈금값 (좌측 등간격)</b>
            <code id="yTicks"></code>
          </div>
        </div>
      </div>
    </div>

    <!-- 업로드 영역 (하단, 비노출 스타일) -->
    <div class="uploadWrap">
      <span id="sheetInfo" class="kv"></span>
      <input id="fileInput" type="file" accept=".xlsx,.xlsm" />
      <button class="btn ghost" id="reuploadBtn" title="저장 데이터 삭제 후 새 파일 선택">데이터 재업로드</button>
    </div>

    <p class="foot">Tip: "확인 값"을 입력하면 z=(x-μ)/σ(절삭 표기), 누적확률(근사), 그리고 <b>해당 ±σ(±1·±2·±3σ)</b>을 알려줍니다. 모든 표시는 소수점 이하 절삭(반올림 없음), 값 표시는 천원 단위.</p>
  </div>

  <!-- SheetJS (XLSX 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const meanEl = document.getElementById('mean');
    const stdEl  = document.getElementById('std');
    const xEl    = document.getElementById('xval');
    const rangesBox = document.getElementById('rangesBox');
    const xinfo = document.getElementById('xinfo');
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const xTicksEl = document.getElementById('xTicks');
    const yTicksEl = document.getElementById('yTicks');
    const statLine = document.getElementById('statLine');
    const sheetInfoEl = document.getElementById('sheetInfo');
    const ddlA = document.getElementById('ddlA');
    const ddlB = document.getElementById('ddlB');
    const fileInput = document.getElementById('fileInput');

    let wbGlobal = null; // 워크북
    let statMax = null, statMin = null
